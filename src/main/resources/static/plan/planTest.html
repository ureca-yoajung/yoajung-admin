<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Edit Plan</title>
    <style>
        body { font-family: sans-serif; padding: 1rem; }
        h2 { margin-top: 1.5rem; }
        .container { max-width: 800px; margin: auto; }
        .field { margin: .5rem 0; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: .5rem; }
        .checkbox-group label { display: flex; align-items: center; gap: .25rem; }
        label span { min-width: 150px; display: inline-block; }
    </style>
</head>
<body>
<div class="container">
    <h1>Edit Plan</h1>
    <form id="plan-form">

        <!-- Plan 기본 정보 -->
        <div class="field">
            <label><span>Name:</span>
                <input type="text" id="plan-name" required>
            </label>
        </div>
        <div class="field">
            <label><span>NetworkType:</span>
                <input type="text" id="plan-networkType" required>
            </label>
        </div>
        <div class="field">
            <label><span>PlanCategory:</span>
                <input type="text" id="plan-category" required>
            </label>
        </div>
        <div class="field">
            <label><span>BasePrice:</span>
                <input type="number" id="plan-basePrice">
            </label>
        </div>
        <div class="field">
            <label><span>DataAllowance:</span>
                <input type="number" id="plan-dataAllowance">
            </label>
        </div>
        <div class="field">
            <label><span>TetheringSharingAllowance:</span>
                <input type="number" id="plan-tethering">
            </label>
        </div>
        <div class="field">
            <label><span>SpeedAfterLimit:</span>
                <input type="number" id="plan-speedAfter">
            </label>
        </div>
        <div class="field">
            <label><span>Description:</span>
                <input type="text" id="plan-description">
            </label>
        </div>

        <div class="field">
            <h2>Services</h2>
            <div id="services-group" class="checkbox-group"></div>
        </div>

        <div class="field">
            <h2>Benefits</h2>
            <div id="benefits-group" class="checkbox-group"></div>
        </div>

        <button type="submit">Save</button>
    </form>
</div>

<script>
    (async function() {
        const params = new URLSearchParams(location.search);
        const planId = params.get('planId') || '1';

        const [planRes, svcRes, benRes] = await Promise.all([
            fetch(`/plans/${planId}`).then(r => r.json()),
            fetch(`/products`).then(r => r.json()),
            fetch(`/benefits`).then(r => r.json())
        ]);

        if (!planRes.data) {
            document.body.innerHTML = '<p style="color:red;">요금제 조회 실패</p>';
            return;
        }

        const plan = planRes.data;
        const allServices = svcRes.data.productResponseList;
        const allBenefits = benRes.data.benefitResponseList;

        document.getElementById('plan-name').value               = plan.name;
        document.getElementById('plan-networkType').value        = plan.networkType;
        document.getElementById('plan-category').value           = plan.planCategory;
        document.getElementById('plan-basePrice').value          = plan.basePrice ?? '';
        document.getElementById('plan-dataAllowance').value      = plan.dataAllowance ?? '';
        document.getElementById('plan-tethering').value         = plan.tetheringSharingAllowance ?? '';
        document.getElementById('plan-speedAfter').value         = plan.speedAfterLimit ?? '';
        document.getElementById('plan-description').value        = plan.description ?? '';

        // 4) Services 체크박스 렌더링
        const svcGroup = document.getElementById('services-group');
        svcGroup.innerHTML = allServices.map(svc => {
            const checked = plan.productResponseList.some(p => p.id === svc.id)
                ? 'checked' : '';
            return `
        <label>
          <input type="checkbox" name="serviceIds" value="${svc.id}" ${checked}>
          ${svc.name}
        </label>
      `;
        }).join('');

        const benGroup = document.getElementById('benefits-group');
        benGroup.innerHTML = allBenefits.map(b => {
            const checked = plan.benefitResponseList.some(x => x.id === b.id)
                ? 'checked' : '';
            return `
        <label>
          <input type="checkbox" name="benefitIds" value="${b.id}" ${checked}>
          ${b.name}
        </label>
      `;
        }).join('');

        document.getElementById('plan-form').addEventListener('submit', async e => {
            e.preventDefault();
            const svcIds = Array.from(document.querySelectorAll('input[name="serviceIds"]:checked'))
                .map(cb => Number(cb.value));
            const benIds = Array.from(document.querySelectorAll('input[name="benefitIds"]:checked'))
                .map(cb => Number(cb.value));

            const payload = {
                name: document.getElementById('plan-name').value,
                networkType: document.getElementById('plan-networkType').value,
                planCategory: document.getElementById('plan-category').value,
                basePrice: parseInt(document.getElementById('plan-basePrice').value) || 0,
                dataAllowance: parseInt(document.getElementById('plan-dataAllowance').value) || 0,
                tetheringSharingAllowance: parseInt(document.getElementById('plan-tethering').value) || 0,
                speedAfterLimit: parseInt(document.getElementById('plan-speedAfter').value) || 0,
                description: document.getElementById('plan-description').value,
                serviceIds: svcIds,
                benefitIds: benIds
            };

            const resp = await fetch(`/plans/${planId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (resp.ok) {
                alert('요금제가 성공적으로 업데이트되었습니다.');
            } else {
                const text = await resp.text();
                alert('업데이트 실패: ' + text);
            }
        });

    })();
</script>
</body>
</html>
